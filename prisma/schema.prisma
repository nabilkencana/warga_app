// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// === USER MANAGEMENT ===
model User {
  id                                                                           Int                  @id @default(autoincrement())
  namaLengkap                                                                  String
  nik                                                                          String               @unique
  tanggalLahir                                                                 DateTime
  tempatLahir                                                                  String
  email                                                                        String               @unique
  nomorTelepon                                                                 String
  instagram                                                                    String?
  facebook                                                                     String?
  alamat                                                                       String
  kota                                                                         String
  negara                                                                       String               @default("Indonesia")
  kodePos                                                                      String
  rtRw                                                                         String
  role                                                                         UserRole             @default(USER)
  fotoProfil                                                                   String?
  bio                                                                          String?
  isVerified                                                                   Boolean              @default(false)
  twoFactorEnabled                                                             Boolean              @default(false)
  twoFactorSecret                                                              String?
  language                                                                     String               @default("id")
  biometricData                                                                String?
  otpCode                                                                      String?
  otpExpire                                                                    DateTime?
  isActive                                                                     Boolean              @default(true)
  createdAt                                                                    DateTime             @default(now())
  updatedAt                                                                    DateTime             @updatedAt

  // KK Verification Fields
  kkFile                                                                       String?
  kkFilePublicId                                                               String?
  kkRejectionReason                                                            String?
  kkVerifiedAt                                                                 DateTime?
  kkVerifiedBy              Int?                // ID admin yang memverifikasi
  kkUploadedAt                                                                 DateTime?

  // Profile fields baru
  profilePicture                                                               String?
  profilePicturePublicId                                                       String?
  newEmailRequested                                                            String?

  // Relations - Existing
  announcements                                                                Announcement[]
  reports                                                                      Report[]
  emergencies                                                                  Emergency[]
  volunteers                                                                   Volunteer[]
  adminDashboards                                                              AdminDashboard[]
  activityLogs                                                                 ActivityLog[]

  // Relations - Dana Community
  transactions                                                                 Transaction[]       @relation("UserTransactions")
  createdTransactions                                                          Transaction[]       @relation("TransactionCreatedBy")
  payments                                                                     Payment[]           @relation("UserPayments")
  memberPayments                                                               MemberPayment[]
  createdFinancialSummaries                                                    FinancialSummary[]
  createdFinancialReports                                                      FinancialReport[]

  // Relations - Bill System
  bills                                                                        Bill[]              @relation("UserBills")
  createdBills                                                                 Bill[]              @relation("CreatedBills")

  // Relations - Notifications
  notifications                                                                Notification[]      @relation("UserNotifications")
  createdNotifications                                                         Notification[]      @relation("NotificationCreatedBy")

  // Relations - Admin verifications (Self-relation)
  // Hanya satu sisi yang memiliki fields/references
  verifiedKKUsers                                                              User[]              @relation("AdminVerifiedUsers")
  verifiedByAdmin                                                              User?               @relation("AdminVerifiedUsers", fields: [kkVerifiedBy], references: [id])

  // New relation for SATPAM role - emergency responses
  satpamEmergencyResponses                                                     EmergencyResponse[]

  @@map("users")
  securities                                                                   Security[]
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  USER
  SATPAM  // Role baru untuk Satpam
}

// === NOTIFICATION SYSTEM ===
model Notification {
  id                                                                                           String            @id @default(cuid())
  userId           Int                  // Penerima notifikasi
  type                                                                                         NotificationType
  title                                                                                        String
  message                                                                                      String
  icon             String?              // Nama icon atau URL icon
  iconColor        String?              // Warna icon dalam hex (#FF5733)
  data             Json?                // Data tambahan untuk action
  isRead                                                                                       Boolean           @default(false)
  isArchived                                                                                   Boolean           @default(false)
  scheduledAt      DateTime?            // Untuk notifikasi terjadwal
  expiresAt        DateTime?            // Kapan notifikasi kedaluwarsa
  createdBy        Int                  // Siapa yang membuat notifikasi
  relatedEntityId  String?              // ID entity terkait (announcement, report, bill, dll)
  relatedEntityType String?             // Tipe entity terkait

  //                                                                                           Relations
  user                                                                                         User             @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)
  createdByUser                                                                                User             @relation("NotificationCreatedBy", fields: [createdBy], references: [id], onDelete: Cascade)

  createdAt                                                                                    DateTime          @default(now())
  updatedAt                                                                                    DateTime          @updatedAt
  readAt                                                                                       DateTime?
  archivedAt                                                                                   DateTime?

  @@map("notifications")
  @@index([userId])
  @@index([userId,                                                                             isRead])
  @@index([userId,                                                                             isArchived])
  @@index([createdAt])
  @@index([scheduledAt])
  @@index([expiresAt])
  securities                                                                                   Security[]       @relation("SecurityNotifications")
}

enum NotificationType {
  SYSTEM       // Notifikasi sistem (maintenance, update, dll)
  ANNOUNCEMENT // Pengumuman baru
  REPORT       // Update laporan
  EMERGENCY    // Keadaan darurat
  BILL         // Tagihan baru/jatuh tempo
  PAYMENT      // Pembayaran berhasil/ditolak
  SECURITY     // Keamanan (login baru, password changed)
  PROFILE      // Update profil
  COMMUNITY    // Kegiatan komunitas
  REMINDER     // Pengingat
  CUSTOM       // Notifikasi kustom
  SOS_ALERT    // Alarm SOS Emergency - NEW
  PATROL       // Notifikasi patroli - NEW
}

// === PROFILE ACTIVITY LOG ===
model ActivityLog {
  id          Int       @id @default(autoincrement())
  action      String
  description String?
  timestamp   DateTime  @default(now())
  ipAddress   String?
  userAgent   String?
  userId      Int
  createAt    DateTime  @default(now())
  updateAt    DateTime  @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("activity_logs")
  @@index([userId])
  @@index([action])
  @@index([timestamp])
}

// === DANA COMMUNITY MODELS ===

model Transaction {
  id                                                                                Int              @id @default(autoincrement())
  amount                                                                            Float
  type                                                                              TransactionType
  category                                                                          String
  description                                                                       String
  date                                                                              DateTime         @default(now())
  proofImage                                                                        String?
  createdBy                                                                         Int
  userId      Int?             // Untuk transaksi yang terkait dengan user tertentu
  paymentId   Int?             // Jika transaksi terkait pembayaran

  //                                                                                Relations
  user                                                                              User?           @relation("UserTransactions", fields: [userId], references: [id])
  createdByUser                                                                     User            @relation("TransactionCreatedBy", fields: [createdBy], references: [id])
  payment                                                                           Payment?        @relation("PaymentTransactions", fields: [paymentId], references: [id])

  createdAt                                                                         DateTime         @default(now())
  updatedAt                                                                         DateTime         @updatedAt

  @@map("transactions")
}

enum TransactionType {
  INCOME
  EXPENSE
}

model Payment {
  id                                                                   Int             @id @default(autoincrement())
  amount                                                               Float
  method                                                               PaymentMethod
  status                                                               PaymentStatus   @default(PENDING)
  description                                                          String
  dueDate                                                              DateTime
  paidDate                                                             DateTime?
  qrCode        String?         // QR Code data untuk QRIS
  bankReference String?         // Referensi bank untuk mobile banking
  receiptImage  String?         // Bukti transfer/tanda terima
  userId        Int             // User yang melakukan pembayaran

  //                                                                   Relations
  user                                                                 User           @relation("UserPayments", fields: [userId], references: [id])
  transactions                                                         Transaction[]  @relation("PaymentTransactions")
  memberPayment                                                        MemberPayment? @relation("PaymentMemberPayment")
  bill                                                                 Bill?          @relation("PaymentBill")

  createdAt                                                            DateTime        @default(now())
  updatedAt                                                            DateTime        @updatedAt

  @@map("payments")
}

enum PaymentMethod {
  CASH
  QRIS
  MOBILE_BANKING
  BANK_TRANSFER
}

enum PaymentStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
  FAILED
}

model MemberPayment {
  id                                               Int        @id @default(autoincrement())
  month     Int       // 1-12
  year      Int       // 2024, 2025, etc
  amount    Float     // Jumlah yang harus dibayar
  isPaid                                           Boolean    @default(false)
  paidDate                                         DateTime?
  dueDate   DateTime  // Tanggal jatuh tempo
  userId                                           Int
  paymentId                                        Int?       @unique // Link ke Payment

  //                                               Relations
  user                                             User      @relation(fields: [userId], references: [id])
  payment                                          Payment?  @relation("PaymentMemberPayment", fields: [paymentId], references: [id])

  @@unique([userId, month, year])
  @@map("member_payments")
}

model FinancialSummary {
  id            Int       @id @default(autoincrement())
  month         Int
  year          Int
  totalIncome   Float     @default(0)
  totalExpense  Float     @default(0)
  balance       Float     @default(0)
  createdBy     Int

  //            Relations
  createdByUser User     @relation(fields: [createdBy], references: [id])

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([month, year])
  @@map("financial_summaries")
}

model TransactionCategory {
  id          Int              @id @default(autoincrement())
  name        String           @unique
  type        TransactionType
  description String?
  isActive    Boolean          @default(true)

  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@map("transaction_categories")
}

model FinancialReport {
  id                                                      Int         @id @default(autoincrement())
  title                                                   String
  description                                             String?
  periodStart                                             DateTime
  periodEnd                                               DateTime
  reportType                                              ReportType
  fileUrl     String?     // URL file laporan (PDF/Excel)
  createdBy                                               Int

  //                                                      Relations
  createdByUser                                           User       @relation(fields: [createdBy], references: [id])

  createdAt                                               DateTime    @default(now())
  updatedAt                                               DateTime    @updatedAt

  @@map("financial_reports")
}

enum ReportType {
  MONTHLY
  QUARTERLY
  YEARLY
  CUSTOM
}

// === BILL SYSTEM ===

model Bill {
  id            String      @id @default(cuid())
  title         String
  description   String
  amount        Float
  dueDate       DateTime
  status        BillStatus  @default(PENDING)
  userId        Int
  createdBy     Int
  paymentId     Int?        @unique // Link ke Payment ketika sudah dibayar
  paidAt        DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  //            Relations
  user          User       @relation("UserBills", fields: [userId], references: [id], onDelete: Cascade)
  createdByUser User       @relation("CreatedBills", fields: [createdBy], references: [id], onDelete: Cascade)
  payment       Payment?   @relation("PaymentBill", fields: [paymentId], references: [id])

  @@map("bills")
}

enum BillStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

// === EXISTING MODELS ===

model Announcement {
  id             Int       @id @default(autoincrement())
  title          String
  description    String
  targetAudience String
  date           DateTime
  day            String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  createdBy      Int

  admin          User     @relation(fields: [createdBy], references: [id], onDelete: Cascade)
}

model Report {
  id                                                              Int       @id @default(autoincrement())
  title                                                           String
  description                                                     String
  category                                                        String
  imageUrl                                                        String?
  imagePublicId  String?   // Tambahan untuk Cloudinary public ID
  status                                                          String    @default("pending")
  createdAt                                                       DateTime  @default(now())
  updatedAt                                                       DateTime  @updatedAt
  userId                                                          Int

  user                                                            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Tambahkan field di Emergency untuk tracking SATPAM
model Emergency {
  id                                                                   Int                  @id @default(autoincrement())
  type                                                                 String
  details                                                              String?
  location                                                             String?
  latitude                                                             String?
  longitude                                                            String?
  needVolunteer                                                        Boolean              @default(false)
  volunteerCount                                                       Int                  @default(0)
  status                                                               String               @default("ACTIVE")
  severity                                                             EmergencySeverity    @default(MEDIUM)
  alarmSent                                                            Boolean              @default(false)
  alarmSentAt                                                          DateTime?

  // Tambahan untuk SATPAM
  needSatpam                                                           Boolean              @default(true) // Defaultnya butuh SATPAM
  satpamAssigned                                                       Boolean              @default(false) // Apakah sudah ada SATPAM yang ditugaskan
  satpamAlertSent                                                      Boolean              @default(false) // Apakah alarm sudah dikirim ke SATPAM
  satpamAlertSentAt DateTime?         // Kapan alarm dikirim ke SATPAM

  createdAt                                                            DateTime             @default(now())
  updatedAt                                                            DateTime             @updatedAt
  userId                                                               Int?

  volunteers                                                           Volunteer[]
  user                                                                 User?               @relation(fields: [userId], references: [id])
  emergencyResponses                                                   EmergencyResponse[]

  @@map("emergencies")
  @@index([severity])
  @@index([alarmSent])
  @@index([status,                                                     createdAt])
  @@index([needSatpam])
  @@index([satpamAssigned])
}

// Tambahkan enum EmergencySeverity setelah SecurityAction
enum EmergencySeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}


model Volunteer {
  id          Int        @id @default(autoincrement())
  emergencyId Int
  userId      Int?
  userName    String?
  userPhone   String?
  skills      String?
  status      String     @default("REGISTERED")
  createdAt   DateTime   @default(now())

  emergency   Emergency @relation(fields: [emergencyId], references: [id], onDelete: Cascade)
  user        User?     @relation(fields: [userId], references: [id])

  @@map("volunteers")
}

model AdminDashboard {
  id                     Int       @id @default(autoincrement())
  totalUsers             Int       @default(0)
  totalReports           Int       @default(0)
  totalEmergencies       Int       @default(0)
  totalVolunteers        Int       @default(0)
  totalVerifiedUsers     Int       @default(0)
  totalActiveEmergencies Int       @default(0)
  reportPendingCount     Int       @default(0)
  reportResolvedCount    Int       @default(0)

  // Dana Community Stats
  totalTransactions      Int       @default(0)
  totalIncome            Float     @default(0)
  totalExpense           Float     @default(0)
  currentBalance         Float     @default(0)
  paidMembers            Int       @default(0)
  unpaidMembers          Int       @default(0)

  // Bill System Stats
  totalBills             Int       @default(0)
  pendingBills           Int       @default(0)
  paidBills              Int       @default(0)
  overdueBills           Int       @default(0)

  date                   DateTime  @default(now())
  adminId                Int

  admin                  User     @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@map("admin_dashboards")
}

// === SECURITY SYSTEM ===
model Security {
  id                                                                                                        Int                  @id @default(autoincrement())
  nama                                                                                                      String
  nik                                                                                                       String               @unique
  email                                                                                                     String               @unique
  nomorTelepon                                                                                              String
  shift                                                                                                     SecurityShift        @default(MORNING)
  status                                                                                                    SecurityStatus       @default(ACTIVE)
  isOnDuty                                                                                                  Boolean              @default(false)
  currentLocation                                                                                           String?
  currentLatitude                                                                                           String?
  currentLongitude                                                                                          String?
  lastActiveAt                                                                                              DateTime?
  deviceToken                                                  String?           // Untuk push notification
  emergencyCount                                                                                            Int                  @default(0) // Jumlah emergency yang ditangani

  // Link ke User untuk SATPAM
  userId                                                                                                    Int?                 @unique // Link ke User untuk role SATPAM

  //                                                                                                        Relations
  emergencyResponses                                                                                        EmergencyResponse[]
  securityLogs                                                                                              SecurityLog[]
  notifications                                                                                             Notification[]      @relation("SecurityNotifications")
  user                                                                                                      User?               @relation(fields: [userId], references: [id]) // Relation ke User

  createdAt                                                                                                 DateTime             @default(now())
  updatedAt                                                                                                 DateTime             @updatedAt

  @@map("security_personnel")
  @@index([shift])
  @@index([status])
  @@index([isOnDuty])
  @@index([userId])
}

enum SecurityShift {
  MORNING     // 06:00 - 14:00
  AFTERNOON   // 14:00 - 22:00
  NIGHT       // 22:00 - 06:00
  FLEXIBLE    // Fleksibel
}

enum SecurityStatus {
  ACTIVE
  INACTIVE
  ON_LEAVE
  SUSPENDED
}

model EmergencyResponse {
  id                                                                                 Int                    @id @default(autoincrement())
  emergencyId                                                                        Int
  securityId                                                                         Int?
  satpamId           Int?             // ID User dengan role SATPAM
  responseTime                                      Int               // Dalam detik
  status                                                                             ResponseStatus         @default(DISPATCHED)
  actionTaken                                                                        String?
  notes                                                                              String?

  // Status khusus untuk SATPAM
  satpamStatus                                                                       SatpamResponseStatus?  @default(PENDING) // Status respon dari SATPAM
  satpamArrivedAt                                                                    DateTime?
  satpamCompletedAt                                                                  DateTime?

  //                                                                                 Relations
  emergency                                                                          Emergency             @relation(fields: [emergencyId], references: [id], onDelete: Cascade)
  security                                                                           Security?             @relation(fields: [securityId], references: [id], onDelete: Cascade)
  satpamUser                                                                         User?                 @relation(fields: [satpamId], references: [id], onDelete: Cascade) // Relation ke User dengan role SATPAM

  arrivedAt                                                                          DateTime?
  completedAt                                                                        DateTime?
  createdAt                                                                          DateTime               @default(now())
  updatedAt                                                                          DateTime               @updatedAt

  @@map("emergency_responses")
  @@unique([emergencyId,                                                             securityId])
  @@unique([emergencyId,                                                             satpamId])
  @@index([satpamId])
  @@index([satpamStatus])
}

// Status khusus untuk respons SATPAM
enum SatpamResponseStatus {
  PENDING      // Menunggu konfirmasi
  ACCEPTED     // Diterima dan sedang menuju lokasi
  REJECTED     // Ditolak (karena sedang menangani kasus lain, dll)
  ARRIVED      // Telah tiba di lokasi
  HANDLING     // Sedang menangani
  RESOLVED     // Selesai menangani
}

enum ResponseStatus {
  DISPATCHED    // Telah dikirim
  EN_ROUTE      // Dalam perjalanan
  ARRIVED       // Telah tiba
  HANDLING      // Sedang menangani
  RESOLVED      // Selesai
  CANCELLED     // Dibatalkan
}

model SecurityLog {
  id         Int             @id @default(autoincrement())
  securityId Int
  action     SecurityAction
  details    String?
  location   String?
  latitude   String?
  longitude  String?

  //         Relations
  security   Security       @relation(fields: [securityId], references: [id], onDelete: Cascade)

  timestamp  DateTime        @default(now())

  @@map("security_logs")
  @@index([securityId])
  @@index([action])
  @@index([timestamp])
}

enum SecurityAction {
  CHECK_IN        // Mulai bertugas
  CHECK_OUT       // Selesai bertugas
  PATROL_START    // Mulai patroli
  PATROL_END      // Selesai patroli
  EMERGENCY_RESPONSE  // Merespons emergency
  LOCATION_UPDATE // Update lokasi
  STATUS_CHANGE   // Perubahan status
  INCIDENT_REPORT // Laporan kejadian
}